<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Forgive Snake</title>
    <style>
        body{
            font-family: Helvetica;
        }

        canvas{
            display: block;
            position: absolute;
            border: 1px solid #000;
            margin: auto;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
        }
        ul{
            display: flex;
            flex-direction: column-reverse;
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    <script>
        // Constants
        var COLS=20, ROWS=20;
        // IDs
        var EMPTY=0, SNAKE=1, FRUIT=2, HEAD=3;
        // Directions
        var LEFT=0, UP=1, RIGHT=2, DOWN=3;
        // KeyCodes
        var KEY_LEFT=37, KEY_UP=38, KEY_RIGHT=39, KEY_DOWN=40, KEY_SPACE=32;
        // alive
        var alive=true;


        var grid = {

            width: null,
            height: null,
            _grid: null,

            init: function(d, c, r) {   // d for default value
                this.width = c;
                this.height = r;

                this._grid = [];
                for (var x = 0; x < c; x ++) {
                    this._grid.push([]);
                    for (var y = 0; y < r; y ++) {
                        this._grid[x].push(d);
                    }
                }
            },

            set: function(val, x, y) {
                this._grid[x][y] = val;
            },

            get: function(x, y) {
                return this._grid[x][y];
            }
        }

        var snake = {
            direction: null,
            last: null,
            _queue: null,

            init: function(d, x, y) {
                this.direction = d;
                this._queue = [];
                this.insert(x, y);
            },

            insert: function(x, y) {

                this._queue.unshift({x:x, y:y});
                this.last = this._queue[0];
                if (this._queue.length > 1) {
                    grid.set(SNAKE, this._queue[1].x, this._queue[1].y);
                }
                grid.set(HEAD, x, y);
            },

            getSize: function() {
                return this._queue.length;
            },

            remove: function() {
                return this._queue.pop();
            }
        }

        function setFood() {
            var empty = [];
            for (var x = 0; x < grid.width; x ++) {
                for (var y = 0; y < grid.height; y ++) {
                    if (grid.get(x, y) === EMPTY) {
                        empty.push({x:x, y:y});
                    }
                }
            }
            var randpos = empty[Math.floor(Math.random()*empty.length)];
            grid.set(FRUIT, randpos.x, randpos.y);
        }

        // Game objects
        var canvas, ctx, keystate, frames, score;

        function main() {
            canvas = document.getElementById('canvas');
            canvas.width = COLS*20;
            canvas.height = ROWS*20;
            ctx = canvas.getContext("2d");

            ctx.font = "15px Helvetica";

            frames = 0;
            keystate = {};
            document.addEventListener("keydown", function(evt) {
                keystate[evt.keyCode] = true;
            })
            document.addEventListener("keyup", function(evt) {
                delete keystate[evt.keyCode];
            })


            init();
            loop();
        }

        function init() {
            grid.init(EMPTY, COLS, ROWS);
            score = 0;
            alive = true;

            var sp = {x:Math.floor(COLS/2), y:Math.floor(ROWS/2)};
            snake.init(UP, sp.x, sp.y);
            grid.set(SNAKE, sp.x, sp.y);

            setFood();
        }

        function loop() {
            update();
            draw();

            window.requestAnimationFrame(loop, canvas);
        }

        function update() {
            if (!alive) {
                if (keystate[KEY_SPACE])
                    return init();
                else
                    return;
            }
            frames ++;

            if (keystate[KEY_LEFT]
                && (snake.direction != RIGHT || snake.getSize() === 1))
                snake.direction = LEFT;
            if (keystate[KEY_UP]
                && (snake.direction != DOWN || snake.getSize() === 1))
                snake.direction = UP;
            if (keystate[KEY_RIGHT]
                && (snake.direction != LEFT || snake.getSize() === 1))
                snake.direction = RIGHT;
            if (keystate[KEY_DOWN]
                && (snake.direction != UP || snake.getSize() === 1))
                snake.direction = DOWN;
            if (keystate[KEY_SPACE])
                return init();


            if (frames%5 === 0) {
                var nx = snake.last.x;
                var ny = snake.last.y;

                switch (snake.direction) {
                    case LEFT:
                        nx --;
                        break;
                    case UP:
                        ny --;
                        break;
                    case RIGHT:
                        nx ++;
                        break;
                    case DOWN:
                        ny ++;
                        break;
                }

                if (nx < 0) {
                    nx = grid.width - 1;
                } else if (nx > grid.width - 1) {
                    nx = 0;
                }

                if (ny < 0) {
                    ny = grid.height - 1;
                } else if (ny > grid.height - 1) {
                    ny = 0;
                }

                if (grid.get(nx, ny) === SNAKE) {
                    alive = false;
                    return;
                }

                if (grid.get(nx, ny) === FRUIT) {
                    score ++;
                    setFood();
                } else {
                    var tail = snake.remove();
                    grid.set(EMPTY, tail.x, tail.y);
                }

                grid.set(SNAKE, nx, ny);

                snake.insert(nx, ny);
            }
        }

        function draw() {
            // tile width and height
            var tw = canvas.width / grid.width;
            var th = canvas.height / grid.height;

            for (var x = 0; x < grid.width; x ++) {
                for (var y = 0; y < grid.height; y ++) {
                    switch (grid.get(x, y)) {
                        case EMPTY:
                            ctx.fillStyle = "#fff";
                            break;
                        case SNAKE:
                            ctx.fillStyle = "#0ff";
                            break;
                        case FRUIT:
                            ctx.fillStyle = "#f00";
                            break;
                        case HEAD:
                            ctx.fillStyle = "#0f0";
                    }
                    ctx.fillRect(x*tw, y*th, tw, th);
                }
            }
            ctx.fillStyle = "#000";
            ctx.fillText("Score: " + score, 10, canvas.height-10);
            if (!alive) {
                ctx.fillText("You Died", canvas.width/2-30, canvas.height/2);
            }
        }

        main();
    </script>
</body>
</html>
